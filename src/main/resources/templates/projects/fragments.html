<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

    <!-- Project Card Fragment -->
    <div th:fragment="project-card(project)" 
         th:data-project-id="${project.id}"
         th:class="${project.status == T(com.agnel.devcollab.entity.Project.Status).DOING} ? 
                   'card mb-3 project-card border-warning shadow-lg' : 
                   (${project.status == T(com.agnel.devcollab.entity.Project.Status).DONE} ? 
                    'card mb-3 project-card border-success shadow-sm' : 
                    'card mb-3 project-card border-light shadow-sm')">
        <div class="card-body">
            <div class="viewing-indicator" style="display: none;"></div>
            
            <!-- TODO Column -->
            <div th:if="${project.status == T(com.agnel.devcollab.entity.Project.Status).TODO}">
                <h6 th:text="${project.name}">Project</h6>
                <p class="text-muted small" th:text="${project.description}">Desc</p>

                <!-- ADD SUBTASK IN TODO -->
                <a th:href="@{'/projects/' + ${project.id} + '/subtasks/new'}"
                   class="btn btn-sm btn-outline-primary mt-2">+ Add Subtask</a>

                <!-- SUBTASKS IN TODO -->
                <div th:each="subtask : ${project.subtasks}" class="subtask-item p-2 rounded mt-2 border">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span th:text="${subtask.name}">Subtask</span>
                        <span class="text-muted">
                            <span class="subtask-timer"
                                th:if="${subtask.pomodoroStart != null}"
                                th:data-start="${subtask.pomodoroStart}"
                                th:data-total-seconds="${subtask.totalSecondsSpent}"
                                th:text="'00:00:00'">00:00:00</span>

                            <span class="subtask-timer-paused"
                                th:unless="${subtask.pomodoroStart != null}"
                                th:data-total-seconds="${subtask.totalSecondsSpent}"
                                th:text="'00:00:00'">00:00:00</span>
                        </span>
                    </div>
                    
                    <!-- Pomodoro Progress Bar -->
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" 
                             th:style="'width: ' + ${subtask.completionPercentage} + '%'"
                             th:title="${subtask.completedPomodoros} + ' / ' + ${subtask.estimatedPomodoros} + ' Pomodoros'">
                        </div>
                    </div>
                    <small class="text-muted">
                        üçÖ <span th:text="${subtask.completedPomodoros}">0</span>/<span th:text="${subtask.estimatedPomodoros}">1</span> 
                        (<span th:text="${#numbers.formatDecimal(subtask.completionPercentage, 1, 0)}">0</span>%)
                        <span th:if="${subtask.currentCycle > 1}" class="badge bg-info">Cycle <span th:text="${subtask.currentCycle}">2</span>/4</span>
                    </small>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <form th:action="@{'/projects/' + ${project.id} + '/pomodoro/start'}" method="post">
                        <button type="submit" class="btn btn-success btn-sm">üçÖ Start Focus</button>
                    </form>
                    <form th:action="@{'/projects/' + ${project.id} + '/delete'}" method="post"
                          onsubmit="return confirm('Delete this project?')">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </div>
            </div>

            <!-- DOING Column -->
            <div th:if="${project.status == T(com.agnel.devcollab.entity.Project.Status).DOING}">
                <!-- PROJECT HEADER -->
                <h6 class="mb-2" th:text="${project.name}">Learn Guitar</h6>
                <p class="text-muted small mb-3" th:if="${project.description}" th:text="${project.description}">Description</p>

                <!-- MAIN TIMER SECTION -->
                <div class="mb-3 p-3 rounded" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <small class="text-muted d-block">Session Timer</small>
                            <div class="pomodoro-timer fs-3 fw-bold"
                                 th:data-project-id="${project.id}"
                                 th:data-start="${project.pomodoroStart}"
                                 th:data-target="${project.isBreak ? project.breakDuration * 60 : project.pomodoroDuration * 60}"
                                 th:data-is-break="${project.isBreak}"
                                 th:text="${project.pomodoroStart != null ? '00:00' : '‚Äî:‚Äî'}">25:00</div>
                            <small class="badge" 
                                  th:classappend="${project.isBreak ? 'bg-info' : 'bg-success'}"
                                  th:text="${project.isBreak ? '‚òï ' + project.breakDuration + ' min break' : 'üçÖ ' + project.pomodoroDuration + ' min focus'}">
                                üçÖ 25 min focus
                            </small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">Total Time</small>
                            <div class="fs-5 fw-bold">
                                <span class="project-timer"
                                    th:if="${project.pomodoroStart != null}"
                                    th:data-start="${project.pomodoroStart}"
                                    th:data-total-seconds="${project.totalSecondsSpent}"
                                    th:data-project-id="${project.id}">00:00:00</span>
                                <span class="project-timer-paused"
                                    th:unless="${project.pomodoroStart != null}"
                                    th:data-total-seconds="${project.totalSecondsSpent}"
                                    th:data-project-id="${project.id}">00:00:00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CONTROLS -->
                    <div class="d-flex gap-2 align-items-center">
                        <form th:if="${project.pomodoroStart == null}"
                              th:action="@{'/projects/' + ${project.id} + '/pomodoro/start'}"
                              method="post"
                              class="flex-grow-1">
                            <button type="submit" class="btn w-100" 
                                    th:classappend="${project.isBreak ? 'btn-info' : 'btn-success'}"
                                    th:text="${project.isBreak ? '‚ñ∂ Start Break' : '‚ñ∂ Start Focus'}">‚ñ∂ Start Focus</button>
                        </form>
                        <form th:if="${project.pomodoroStart != null}"
                              th:action="@{'/projects/' + ${project.id} + '/pomodoro/stop'}"
                              method="post"
                              class="flex-grow-1">
                            <button type="submit" class="btn btn-secondary w-100">‚è∏ Pause</button>
                        </form>
                        
                        <!-- Settings -->
                        <div class="dropdown" th:if="${project.pomodoroStart == null}">
                            <button class="btn btn-outline-secondary dropdown-toggle" 
                                    type="button" 
                                    th:id="'settings-' + ${project.id}"
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false">
                                ‚öôÔ∏è
                            </button>
                            <ul class="dropdown-menu" th:aria-labelledby="'settings-' + ${project.id}">
                                <li><h6 class="dropdown-header">Focus Duration</h6></li>
                                <li>
                                    <form th:action="@{'/projects/' + ${project.id} + '/pomodoro/duration'}" method="post">
                                        <input type="hidden" name="duration" value="15">
                                        <button class="dropdown-item" type="submit">15 min</button>
                                    </form>
                                </li>
                                <li>
                                    <form th:action="@{'/projects/' + ${project.id} + '/pomodoro/duration'}" method="post">
                                        <input type="hidden" name="duration" value="25">
                                        <button class="dropdown-item" type="submit">25 min ‚≠ê</button>
                                    </form>
                                </li>
                                <li>
                                    <form th:action="@{'/projects/' + ${project.id} + '/pomodoro/duration'}" method="post">
                                        <input type="hidden" name="duration" value="45">
                                        <button class="dropdown-item" type="submit">45 min</button>
                                    </form>
                                </li>
                                <li>
                                    <form th:action="@{'/projects/' + ${project.id} + '/pomodoro/duration'}" method="post">
                                        <input type="hidden" name="duration" value="60">
                                        <button class="dropdown-item" type="submit">60 min</button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- SUBTASKS SECTION -->
                <div th:if="${!project.subtasks.isEmpty()}" class="mb-3">
                    <small class="text-muted fw-bold d-block mb-2">SUBTASKS</small>
                    <div th:each="subtask : ${project.subtasks}" class="subtask-item p-2 rounded mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <span th:text="${subtask.name}">Practice Scales</span>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <small class="subtask-timer-paused text-muted"
                                    th:unless="${subtask.pomodoroStart != null}"
                                    th:data-total-seconds="${subtask.totalSecondsSpent}"
                                    th:data-subtask-id="${subtask.id}">00:00:00</small>
                                <small class="subtask-timer text-success fw-bold"
                                    th:if="${subtask.pomodoroStart != null}"
                                    th:data-start="${subtask.pomodoroStart}"
                                    th:data-total-seconds="${subtask.totalSecondsSpent}"
                                    th:data-subtask-id="${subtask.id}">00:00:00</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ADD SUBTASK -->
                <a th:href="@{'/projects/' + ${project.id} + '/subtasks/new'}"
                   class="btn btn-sm btn-outline-primary mb-3 w-100">+ Add Subtask</a>

                <!-- ACTION BUTTONS -->
                <div class="d-flex gap-2">
                    <form th:action="@{'/projects/' + ${project.id} + '/status'}" method="post" class="flex-grow-1">
                        <input type="hidden" name="status" value="DONE">
                        <button type="submit" class="btn btn-success w-100">‚úì Done</button>
                    </form>
                    <form th:action="@{'/projects/' + ${project.id} + '/status'}" method="post">
                        <input type="hidden" name="status" value="TODO">
                        <button type="submit" class="btn btn-outline-secondary">‚Üê Back</button>
                    </form>
                    <form th:action="@{'/projects/' + ${project.id} + '/delete'}" method="post"
                          onsubmit="return confirm('Delete this project?')">
                        <button type="submit" class="btn btn-outline-danger">üóë</button>
                    </form>
                </div>
            </div>

            <!-- DONE Column -->
            <div th:if="${project.status == T(com.agnel.devcollab.entity.Project.Status).DONE}">
                <h6 th:text="${project.name}">Finished</h6>
                <p class="text-success">
                    Completed in 
                    <strong class="completed-time" 
                            th:data-total-seconds="${project.totalSecondsSpent}">
                        <span>Calculating...</span>
                    </strong>
                </p>
                <form th:action="@{'/projects/' + ${project.id} + '/delete'}" method="post"
                      onsubmit="return confirm('Delete this project?')">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Column Fragment -->
    <div th:fragment="column">
        <div th:each="project : ${projects}" th:replace="~{projects/fragments :: project-card(project=${project})}"></div>
    </div>

    <!-- Empty Fragment -->
    <div th:fragment="empty"></div>

</body>
</html>
