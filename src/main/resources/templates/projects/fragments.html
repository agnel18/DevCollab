<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

    <!-- Project Card Fragment -->
    <div th:fragment="project-card" 
         th:data-project-id="${project.id}"
         th:class="${project.status == T(com.agnel.devcollab.entity.Project.Status).DOING} ? 
                   'card mb-3 project-card border-warning shadow-lg' : 
                   (${project.status == T(com.agnel.devcollab.entity.Project.Status).DONE} ? 
                    'card mb-3 project-card border-success shadow-sm' : 
                    'card mb-3 project-card border-light shadow-sm')">
        <div class="card-body">
            <div class="viewing-indicator" style="display: none;"></div>
            
            <!-- TODO Column -->
            <div th:if="${project.status == T(com.agnel.devcollab.entity.Project.Status).TODO}">
                <h6 th:text="${project.name}">Project</h6>
                <p class="text-muted small" th:text="${project.description}">Desc</p>

                <!-- ADD SUBTASK IN TODO -->
                <a th:href="@{'/projects/' + ${project.id} + '/subtasks/new'}"
                   class="btn btn-sm btn-outline-primary mt-2">+ Add Subtask</a>

                <!-- SUBTASKS IN TODO -->
                <div th:each="subtask : ${project.subtasks}" class="subtask-item p-2 rounded mt-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span th:text="${subtask.name}">Subtask</span>
                        <span class="text-muted">
                            <span class="subtask-timer"
                                th:if="${subtask.pomodoroStart != null}"
                                th:data-start="${subtask.pomodoroStart}"
                                th:data-total-seconds="${subtask.totalSecondsSpent}"
                                th:text="'00:00:00'">00:00:00</span>

                            <span class="subtask-timer-paused"
                                th:unless="${subtask.pomodoroStart != null}"
                                th:data-total-seconds="${subtask.totalSecondsSpent}"
                                th:text="'00:00:00'">00:00:00</span>
                        </span>
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <form hx-put="@{'/projects/' + ${project.id} + '/status'}"
                          hx-target="closest .project-card" 
                          hx-swap="outerHTML">
                        <input type="hidden" name="status" value="DOING">
                        <button class="btn btn-warning btn-sm">Start â†’</button>
                    </form>
                    <form hx-delete="@{'/projects/' + ${project.id}}"
                          hx-target="closest .project-card" 
                          hx-swap="outerHTML"
                          hx-confirm="Delete this project?">
                        <button class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </div>
            </div>

            <!-- DOING Column -->
            <div th:if="${project.status == T(com.agnel.devcollab.entity.Project.Status).DOING}">
                <!-- PROJECT TITLE + TOTAL TIME -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="mb-0" th:text="${project.name}">Learn Guitar</h6>
                    <div class="text-end">
                        <strong>Total Time:</strong><br>
                        <!-- LIVE TIMER WHEN RUNNING -->
                        <span class="project-timer text-success"
                            th:if="${project.pomodoroStart != null}"
                            th:data-start="${project.pomodoroStart}"
                            th:data-total-seconds="${project.totalSecondsSpent}"
                            th:data-project-id="${project.id}">00:00:00</span>

                        <!-- STATIC TIME WHEN PAUSED -->
                        <span class="project-timer-paused text-muted"
                            th:unless="${project.pomodoroStart != null}"
                            th:data-total-seconds="${project.totalSecondsSpent}"
                            th:data-project-id="${project.id}">00:00:00</span>
                    </div>
                </div>

                <!-- PROJECT TIMER -->
                <div class="mb-3">
                    <form th:if="${project.pomodoroStart == null}"
                          hx-post="@{'/projects/' + ${project.id} + '/pomodoro/start'}"
                          hx-target="closest .project-card"
                          hx-swap="outerHTML"
                          class="d-inline">
                        <button type="submit" class="btn btn-sm timer-btn-start" 
                                th:classappend="${project.totalSecondsSpent > 0 ? 'btn-warning' : 'btn-success'}"
                                th:text="${project.totalSecondsSpent > 0 ? 'Resume' : 'Start'}">Start</button>
                    </form>
                    <form th:if="${project.pomodoroStart != null}"
                          hx-post="@{'/projects/' + ${project.id} + '/pomodoro/stop'}"
                          hx-target="closest .project-card"
                          hx-swap="outerHTML"
                          class="d-inline">
                        <button type="submit" class="btn btn-secondary btn-sm">Pause</button>
                    </form>
                </div>

                <a th:href="@{'/projects/' + ${project.id} + '/subtasks/new'}"
                   class="btn btn-outline-primary btn-sm mb-3">+ Add Subtask</a>

                <!-- SUBTASKS -->
                <div th:each="subtask : ${project.subtasks}" class="subtask-item p-3 rounded mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong th:text="${subtask.name}">Practice Scales</strong>
                        <div>
                            <!-- Live timer when running -->
                            <span class="subtask-timer text-success"
                                th:if="${subtask.pomodoroStart != null}"
                                th:data-start="${subtask.pomodoroStart}"
                                th:data-total-seconds="${subtask.totalSecondsSpent}"
                                th:data-subtask-id="${subtask.id}">00:00:00</span>

                            <!-- Static time when paused -->
                            <span class="subtask-timer-paused text-muted"
                                th:unless="${subtask.pomodoroStart != null}"
                                th:data-total-seconds="${subtask.totalSecondsSpent}"
                                th:data-subtask-id="${subtask.id}">00:00:00</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <form th:if="${subtask.pomodoroStart == null}"
                              th:action="@{'/subtasks/' + ${subtask.id} + '/pomodoro/start'}" 
                              method="post"
                              class="d-inline">
                            <button type="submit" class="btn btn-sm"
                                    th:classappend="${subtask.totalSecondsSpent > 0 ? 'btn-warning' : 'btn-success'}"
                                    th:text="${subtask.totalSecondsSpent > 0 ? 'Resume' : 'Start'}">Start</button>
                        </form>
                        <form th:if="${subtask.pomodoroStart != null}"
                              th:action="@{'/subtasks/' + ${subtask.id} + '/pomodoro/stop'}" 
                              method="post"
                              class="d-inline">
                            <button type="submit" class="btn btn-secondary btn-sm">Pause</button>
                        </form>
                    </div>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="mt-4 d-flex gap-2 flex-wrap">
                    <form hx-put="@{'/projects/' + ${project.id} + '/status'}"
                          hx-target="closest .project-card" 
                          hx-swap="outerHTML">
                        <input type="hidden" name="status" value="DONE">
                        <button class="btn btn-success">Done</button>
                    </form>
                    <form hx-put="@{'/projects/' + ${project.id} + '/status'}"
                          hx-target="closest .project-card" 
                          hx-swap="outerHTML">
                        <input type="hidden" name="status" value="TODO">
                        <button class="btn btn-outline-secondary">Back</button>
                    </form>
                    <form hx-delete="@{'/projects/' + ${project.id}}"
                          hx-target="closest .project-card" 
                          hx-swap="outerHTML"
                          hx-confirm="Delete this project?">
                        <button class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>

            <!-- DONE Column -->
            <div th:if="${project.status == T(com.agnel.devcollab.entity.Project.Status).DONE}">
                <h6 th:text="${project.name}">Finished</h6>
                <p class="text-success">
                    Completed in 
                    <strong class="completed-time" 
                            th:data-total-seconds="${project.totalSecondsSpent}">
                        <span>Calculating...</span>
                    </strong>
                </p>
                <form hx-delete="@{'/projects/' + ${project.id}}"
                      hx-target="closest .project-card" 
                      hx-swap="outerHTML"
                      hx-confirm="Delete this project?">
                    <button class="btn btn-sm btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Column Fragment -->
    <div th:fragment="column">
        <div th:each="project : ${projects}" th:replace="~{projects/fragments :: project-card(project=${project})}"></div>
    </div>

    <!-- Empty Fragment -->
    <div th:fragment="empty"></div>

</body>
</html>
