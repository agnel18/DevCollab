<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">My Projects</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }
        .timer { 
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace; 
            font-weight: 600; 
            font-size: 1.1em; 
            letter-spacing: 0.5px;
        }
        .subtask-item { 
            background: #f8f9fa; 
            border-left: 4px solid #007bff; 
            transition: all 0.2s ease;
        }
        .subtask-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        /* Cursor tracking - Linear/Figma style */
        .remote-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .cursor-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 11px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        .cursor-label {
            margin-left: 6px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            font-weight: 500;
        }
        .project-card {
            position: relative;
            transition: all 0.2s ease;
            cursor: move;
        }
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        }
        .project-card.sortable-ghost {
            opacity: 0.4;
            background: #e9ecef;
        }
        .project-card.sortable-drag {
            opacity: 1;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
            transform: rotate(3deg);
        }
        .sortable-list {
            min-height: 100px;
        }
        .viewing-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.75);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 10;
            font-weight: 500;
        }
        
        /* Toast notifications - Modern style */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast-item {
            background: white;
            border-left: 4px solid #007bff;
            padding: 14px 18px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            min-width: 320px;
            max-width: 400px;
            animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .toast-item.success { border-left-color: #28a745; }
        .toast-item.warning { border-left-color: #ffc107; }
        .toast-item.error { border-left-color: #dc3545; }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Chat sidebar - Modern style */
        .chat-sidebar {
            position: fixed;
            right: -420px;
            top: 0;
            width: 420px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 16px rgba(0,0,0,0.1);
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .chat-sidebar.open {
            right: 0;
        }
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        .chat-header h5 {
            margin: 0;
            font-weight: 600;
            font-size: 18px;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafbfc;
        }
        .chat-message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chat-message-header {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .chat-message-body {
            color: #212529;
            line-height: 1.5;
        }
        .chat-message .mention {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: white;
        }
        .chat-input-area .input-group {
            display: flex;
            gap: 8px;
        }
        .chat-input-area input {
            flex: 1;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 10px 14px;
        }
        .chat-input-area button {
            border-radius: 8px;
            padding: 10px 20px;
        }

        /* Column styles */
        .column-header {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .column-badge {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 12px;
        }
        /* Compact controls */
        .control-bar { display:flex; gap:8px; align-items:center; }
        .btn-compact { padding: 4px 8px; font-size: 12px; line-height: 1.2; }
        .timer-controls { display:flex; gap:6px; flex-wrap:nowrap; }
    </style>

<body>
<div id="main-content" hx-ext="ws" ws-connect="/ws">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 th:text="${pageTitle}" style="font-weight: 700; color: #212529;">My Projects</h1>
        <div>
            <a href="/projects/new" class="btn btn-success me-2">+ New Project</a>
            <form th:action="@{/logout}" method="post" class="d-inline" th:if="${#authorization.expression('isAuthenticated()')}">
                <button type="submit" class="btn btn-outline-danger">Logout</button>
            </form>
        </div>
            <div id="projects-page-hook"></div>

            <div class="control-bar mb-2">
                <a href="/projects/new" class="btn btn-success btn-compact">+ New Project</a>
                <span style="margin-left:8px;color:#888;">Track work with compact timers.</span>
            </div>
    </div>

    <div class="row g-4" id="board-columns">
        <!-- TO DO -->
        <div class="col-md-4" id="todo-column">
            <div class="bg-white rounded shadow p-3" style="min-height: 500px;">
                <div class="column-header">
                    <h5 class="text-primary fw-bold mb-0">To Do</h5>
                    <span class="badge bg-primary column-badge" th:text="${todo.size()}">0</span>
                </div>
                <div class="mt-3 sortable-list" id="todo-list" data-status="TODO">
                    <div th:each="project : ${todo}" th:insert="~{projects/fragments :: project-card(project=${project})}"></div>
                </div>
            </div>
        </div>

        <!-- DOING -->
        <div class="col-md-4" id="doing-column">
            <div class="bg-white rounded shadow p-3" style="min-height: 500px;">
                <div class="column-header">
                    <h5 class="text-warning fw-bold mb-0">Doing</h5>
                    <span class="badge bg-warning text-dark column-badge" th:text="${doing.size()}">0</span>
                </div>
                <div class="mt-3 sortable-list" id="doing-list" data-status="DOING">
                    <div th:each="project : ${doing}" th:insert="~{projects/fragments :: project-card(project=${project})}"></div>
                </div>
            </div>
        </div>

        <!-- DONE -->
        <div class="col-md-4" id="done-column">
            <div class="bg-white rounded shadow p-3" style="min-height: 500px;">
                <div class="column-header">
                    <h5 class="text-success fw-bold mb-0">Done</h5>
                    <span class="badge bg-success column-badge" th:text="${done.size()}">0</span>
                </div>
                <div class="mt-3 sortable-list" id="done-list" data-status="DONE">
                    <div th:each="project : ${done}" th:insert="~{projects/fragments :: project-card(project=${project})}"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- EMPTY STATE -->
    <div th:if="${todo.isEmpty() and doing.isEmpty() and done.isEmpty()}" class="text-center py-5">
        <h3 style="color: #6c757d; font-weight: 600;">No projects yet</h3>
        <p class="text-muted mb-4">Get started by creating your first project</p>
        <a href="/projects/new" class="btn btn-primary btn-lg">Create Your First Project</a>
    </div>
</div>

<!-- Chat Sidebar -->
<div id="chatSidebar" class="chat-sidebar">
    <div class="chat-header">
        <h5 class="mb-0">ðŸ’¬ Project Chat</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="closeChat()" style="border: none; background: transparent; font-size: 24px; line-height: 1;">Ã—</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input-area">
        <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="Type a message... (use @username to mention)" onkeypress="handleChatKeyPress(event)">
            <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<script th:inline="javascript">
    let userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    let userName = null;
    let userColor = null;
    let currentChatProjectId = null;
    let remoteCursors = {};
    let cursorThrottle = null;
    let notificationPermission = null;

    // ========== INITIALIZE USER ==========
    (function() {
        // Get or prompt for user name
        const storedName = localStorage.getItem('devcollab_name');
        if (storedName) {
            userName = storedName;
        } else {
            const input = prompt("What's your name?");
            if (input && input.trim()) {
                userName = input.trim();
                localStorage.setItem('devcollab_name', userName);
            } else {
                const animals = ['Panda', 'Tiger', 'Eagle', 'Fox', 'Lion', 'Bear', 'Wolf', 'Hawk', 'Falcon', 'Jaguar'];
                userName = 'Guest ' + animals[Math.floor(Math.random() * animals.length)];
                localStorage.setItem('devcollab_name', userName);
            }
        }
        
        // Get or create user color
        let storedColor = localStorage.getItem('devcollab_color');
        if (storedColor) {
            userColor = storedColor;
        } else {
            const colors = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", "#98D8C8", "#F7DC6F", "#BB8FCE", "#85C1E2", "#F1948A", "#85C1E9"];
            userColor = colors[Math.floor(Math.random() * colors.length)];
            localStorage.setItem('devcollab_color', userColor);
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                notificationPermission = permission;
            });
        } else if ('Notification' in window) {
            notificationPermission = Notification.permission;
        }
    })();

    // ========== HELPER FUNCTIONS ==========
    function getUserName() {
        return userName || localStorage.getItem('devcollab_name') || 'Guest';
    }

    function getUserColor() {
        return userColor || localStorage.getItem('devcollab_color') || '#007bff';
    }

    // ========== WEBSOCKET CONNECTION ==========
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('âœ… Connected to WebSocket');
            
            // Subscribe to project updates
            stompClient.subscribe('/topic/project-updates', function(update) {
                const data = JSON.parse(update.body);
                handleProjectUpdate(data);
            });

            // Subscribe to chat messages
            stompClient.subscribe('/topic/chat', function(message) {
                const data = JSON.parse(message.body);
                if (data.projectId === currentChatProjectId) {
                    addChatMessage(data);
                }
            });

            // Subscribe to notifications (for @mentions)
            stompClient.subscribe('/topic/notifications', function(notification) {
                const data = JSON.parse(notification.body);
                // Check if this notification is for the current user
                if (data.message && data.message.toLowerCase().includes(userName.toLowerCase())) {
                    showBrowserNotification(data.message, 'You were mentioned!');
                }
            });

            // Subscribe to cursor movements
            stompClient.subscribe('/topic/cursors', function(cursor) {
                const data = JSON.parse(cursor.body);
                if (data.userId !== userId) {
                    updateRemoteCursor(data);
                }
            });

            // Subscribe to presence
            stompClient.subscribe('/topic/presence', function(presence) {
                const data = JSON.parse(presence.body);
                // Handle presence updates if needed
            });

            // Send presence
            sendPresence(true);
        }, function(error) {
            console.error('WebSocket connection error:', error);
            setTimeout(connect, 5000); // Reconnect after 5 seconds
        });
    }

    function sendPresence(connected) {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/presence", {}, JSON.stringify({
                userId: userId,
                userName: userName,
                userColor: userColor,
                connected: connected
            }));
        }
    }

    // ========== PROJECT UPDATE HANDLER ==========
    function handleProjectUpdate(data) {
        // Show toast notification (except for own actions)
        if (data.userName !== userName) {
            let message = '';
            let toastClass = 'success';
            
            switch(data.action) {
                case 'MOVED':
                    message = `${data.userName} moved '${data.projectName}' to ${data.status}`;
                    toastClass = 'success';
                    // Reload all columns to handle move between columns
                    reloadAllColumns();
                    return; // Early return since we handled reload
                    break;
                case 'TIMER_STARTED':
                    message = `${data.userName} started timer on '${data.projectName}'`;
                    toastClass = 'success';
                    showBrowserNotification(message, 'Timer Started');
                    break;
                case 'TIMER_STOPPED':
                    message = `${data.userName} paused timer on '${data.projectName}'`;
                    toastClass = 'warning';
                    break;
                case 'CREATED':
                    message = `${data.userName} created '${data.projectName}'`;
                    toastClass = 'success';
                    // Will reload all columns below
                    break;
                case 'DELETED':
                    message = `${data.userName} deleted '${data.projectName}'`;
                    toastClass = 'error';
                    // Will handle removal below
                    break;
                case 'SUBTASK_ADDED':
                    message = `${data.userName} added a subtask to '${data.projectName}'`;
                    toastClass = 'success';
                    break;
            }
            
            if (message) {
                showToast(message, toastClass);
            }
        }

        // Reload the affected columns via HTMX
        if (data.action === 'CREATED') {
            // Reload all columns for new project
            reloadAllColumns();
        } else if (data.action === 'DELETED') {
            // Remove card from DOM if it exists
            const cardToRemove = document.querySelector(`[data-project-id="${data.projectId}"]`);
            if (cardToRemove) {
                cardToRemove.remove();
                updateColumnBadges();
            }
        } else if (data.status) {
            const status = data.status.toLowerCase();
            reloadColumn(status);
        } else if (data.action === 'TIMER_STARTED' || data.action === 'TIMER_STOPPED') {
            // For timer updates, reload the column where the project is
            if (data.projectId) {
                const card = document.querySelector(`[data-project-id="${data.projectId}"]`);
                if (card) {
                    const column = card.closest('[id$="-column"]');
                    if (column) {
                        const columnId = column.id;
                        const status = columnId.replace('-column', '');
                        reloadColumn(status);
                    }
                }
            }
        }
    }

    function reloadColumn(status) {
        setTimeout(() => {
            htmx.ajax('GET', `/projects/column/${status}`, {
                target: `#${status}-list`,
                swap: 'innerHTML',
                headers: {
                    'HX-User-Name': getUserName(),
                    'HX-User-Color': getUserColor()
                }
            }).then(() => {
                updateTimers();
                updateColumnBadges();
            });
        }, 100);
    }

    function reloadAllColumns() {
        ['todo', 'doing', 'done'].forEach(status => {
            reloadColumn(status);
        });
    }

    function updateColumnBadges() {
        ['todo', 'doing', 'done'].forEach(status => {
            const list = document.querySelector(`#${status}-list`);
            const badge = document.querySelector(`#${status}-column .column-badge`);
            if (list && badge) {
                // Count actual project cards (not empty messages)
                const cards = list.querySelectorAll('.project-card');
                badge.textContent = cards.length;
            }
        });
    }

    // Initialize column badges on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateColumnBadges();
    });

    // ========== TOAST NOTIFICATIONS ==========
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-item ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // ========== BROWSER NOTIFICATIONS ==========
    function showBrowserNotification(message, title = 'DevCollab') {
        if ('Notification' in window && notificationPermission === 'granted') {
            new Notification(title, {
                body: message,
                icon: '/favicon.ico',
                badge: '/favicon.ico',
                tag: 'devcollab-notification'
            });
        }
    }

    // ========== CURSOR TRACKING ==========
    function updateRemoteCursor(data) {
        let cursor = remoteCursors[data.userId];
        if (!cursor) {
            cursor = document.createElement('div');
            cursor.className = 'remote-cursor';
            cursor.id = 'cursor-' + data.userId;
            
            const avatar = document.createElement('div');
            avatar.className = 'cursor-avatar';
            avatar.style.backgroundColor = data.userColor;
            avatar.textContent = data.userName.charAt(0).toUpperCase();
            
            const label = document.createElement('div');
            label.className = 'cursor-label';
            label.textContent = data.userName;
            
            cursor.appendChild(avatar);
            cursor.appendChild(label);
            document.body.appendChild(cursor);
            remoteCursors[data.userId] = cursor;
        }

        cursor.style.left = data.x + 'px';
        cursor.style.top = data.y + 'px';

        // Show viewing indicator on project card
        if (data.projectId) {
            const projectCard = document.querySelector(`[data-project-id="${data.projectId}"]`);
            if (projectCard) {
                const indicator = projectCard.querySelector('.viewing-indicator');
                if (indicator) {
                    indicator.textContent = data.userName + ' is viewing';
                    indicator.style.display = 'block';
                    clearTimeout(indicator.timeout);
                    indicator.timeout = setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            }
        }
    }

    // Track local cursor
    document.addEventListener('mousemove', function(e) {
        if (cursorThrottle) return;
        cursorThrottle = setTimeout(() => {
            cursorThrottle = null;
            
            const projectCard = e.target.closest('.project-card');
            const projectId = projectCard ? projectCard.dataset.projectId : null;

            if (stompClient && stompClient.connected) {
                stompClient.send("/app/cursor", {}, JSON.stringify({
                    userId: userId,
                    userName: userName,
                    userColor: userColor,
                    x: e.clientX,
                    y: e.clientY,
                    projectId: projectId
                }));
            }
        }, 50);
    });

    // ========== CHAT FUNCTIONS ==========
    function openChat(projectId) {
        currentChatProjectId = projectId;
        document.getElementById('chatSidebar').classList.add('open');
        document.getElementById('chatMessages').innerHTML = '';
        // Focus input
        setTimeout(() => {
            document.getElementById('chatInput').focus();
        }, 300);
    }

    function closeChat() {
        document.getElementById('chatSidebar').classList.remove('open');
        currentChatProjectId = null;
    }

    function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message || !currentChatProjectId) return;

        const chatData = {
            projectId: currentChatProjectId,
            message: message,
            userName: userName,
            userColor: userColor,
            timestamp: new Date().toISOString()
        };

        // Show message immediately (optimistic UI)
        addChatMessage(chatData);

        if (stompClient && stompClient.connected) {
            stompClient.send("/app/chat", {}, JSON.stringify(chatData));
        }

        input.value = '';
    }

    function handleChatKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendChatMessage();
        }
    }

    function addChatMessage(data) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';
        
        const header = document.createElement('div');
        header.className = 'chat-message-header';
        const time = new Date(data.timestamp).toLocaleTimeString();
        header.innerHTML = `<strong style="color: ${data.userColor}">${data.userName}</strong> <span class="text-muted">${time}</span>`;
        
        const body = document.createElement('div');
        body.className = 'chat-message-body';
        
        // Parse @mentions
        let messageText = data.message;
        messageText = messageText.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        body.innerHTML = messageText;
        
        messageDiv.appendChild(header);
        messageDiv.appendChild(body);
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Add click handler to project cards for chat (double-click)
    document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('dblclick', function(e) {
            const projectCard = e.target.closest('.project-card');
            if (projectCard) {
                const projectId = projectCard.dataset.projectId;
                if (projectId) {
                    openChat(projectId);
                }
            }
        });
    });

    // ========== TIMER FUNCTIONS ==========
    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return '00:00:00';
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function formatPomodoroTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return '00:00';
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function formatTimeHuman(totalSeconds) {
        if (!totalSeconds || totalSeconds <= 0) return '0s';
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        const parts = [];
        if (hours > 0) parts.push(`${hours}h`);
        if (minutes > 0) parts.push(`${minutes}m`);
        if (seconds > 0 && totalSeconds < 3600) parts.push(`${seconds}s`);
        
        return parts.length > 0 ? parts.join(' ') : '0s';
    }

    function updateTimers() {
        // Update Pomodoro countdown timers
        document.querySelectorAll('.pomodoro-timer[data-start]').forEach(timer => {
            const startTime = timer.dataset.start;
            if (!startTime || startTime === 'null') {
                const target = parseInt(timer.dataset.target || 1500);
                timer.textContent = formatPomodoroTime(target);
                return;
            }
            
            const start = new Date(startTime).getTime();
            if (isNaN(start)) return;

            const target = parseInt(timer.dataset.target || 1500); // Default 25 min
            const now = new Date().getTime();
            const elapsedSeconds = Math.floor((now - start) / 1000);
            const remainingSeconds = Math.max(0, target - elapsedSeconds);
            
            timer.textContent = formatPomodoroTime(remainingSeconds);
            
            // Check if timer completed
            if (remainingSeconds === 0 && !timer.dataset.notified) {
                timer.dataset.notified = 'true';
                const isBreak = timer.dataset.isBreak === 'true';
                const message = isBreak ? 'Break time is over! Ready to focus?' : 'Focus session complete! Time for a break! ðŸŽ‰';
                showBrowserNotification(message, 'Pomodoro Complete');
                showToast(message, 'success');
                
                // Play sound notification (optional)
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCh+z/LZhzYIHGSt6+OJOggQT6fg7r58IAMPZr7s56xWFQlXsObxs2kbBDBwzPLTgisFJHfJ8N2MOw==');
                    audio.play().catch(() => {});
                } catch(e) {}
            }
        });

        // Update running project timers
        document.querySelectorAll('.project-timer[data-start]').forEach(timer => {
            const startTime = timer.dataset.start;
            if (!startTime || startTime === 'null') return;
            
            const start = new Date(startTime).getTime();
            if (isNaN(start)) return;

            const totalSeconds = parseInt(timer.dataset.totalSeconds || 0);
            const now = new Date().getTime();
            const currentSessionSeconds = Math.floor((now - start) / 1000);
            const totalSecondsSpent = currentSessionSeconds + totalSeconds;
            timer.textContent = formatTime(totalSecondsSpent);
        });

        // Update paused project timers
        document.querySelectorAll('.project-timer-paused').forEach(timer => {
            const totalSeconds = parseInt(timer.dataset.totalSeconds || 0);
            timer.textContent = formatTime(totalSeconds);
        });

        // Update running subtask timers
        document.querySelectorAll('.subtask-timer[data-start]').forEach(timer => {
            const startTime = timer.dataset.start;
            if (!startTime || startTime === 'null') return;
            
            const start = new Date(startTime).getTime();
            if (isNaN(start)) return;

            const totalSeconds = parseInt(timer.dataset.totalSeconds || 0);
            const now = new Date().getTime();
            const currentSessionSeconds = Math.floor((now - start) / 1000);
            const totalSecondsSpent = currentSessionSeconds + totalSeconds;
            timer.textContent = formatTime(totalSecondsSpent);
        });

        // Update paused subtask timers
        document.querySelectorAll('.subtask-timer-paused').forEach(timer => {
            const totalSeconds = parseInt(timer.dataset.totalSeconds || 0);
            timer.textContent = formatTime(totalSeconds);
        });

        // Update completed time display
        document.querySelectorAll('.completed-time').forEach(elem => {
            const totalSeconds = parseInt(elem.dataset.totalSeconds || 0);
            const span = elem.querySelector('span');
            if (span) {
                span.textContent = formatTimeHuman(totalSeconds);
            }
        });
    }

    // ========== HTMX CONFIGURATION ==========
    // Configure HTMX to send user info in headers
    document.body.addEventListener('htmx:configRequest', function(event) {
        event.detail.headers['HX-User-Name'] = getUserName();
        event.detail.headers['HX-User-Color'] = getUserColor();
    });

    // Handle HTMX swaps to reinitialize timers and move cards to correct columns
    document.body.addEventListener('htmx:afterSwap', function(event) {
        updateTimers();
        
        // If a project card was swapped, check if it needs to move to a different column
        const swappedCard = event.detail.target;
        if (swappedCard && swappedCard.classList.contains('project-card')) {
            // Determine status from card content
            let targetStatus = null;
            
            // Check for status indicators in the card
            if (swappedCard.querySelector('.project-timer, .project-timer-paused')) {
                targetStatus = 'doing'; // Has timer = DOING
            } else if (swappedCard.querySelector('.completed-time')) {
                targetStatus = 'done'; // Has completed time = DONE
            } else {
                targetStatus = 'todo'; // Default = TODO
            }
            
            if (targetStatus) {
                const targetList = document.querySelector(`#${targetStatus}-list`);
                const currentList = swappedCard.parentElement;
                
                // Only move if not already in correct column
                if (targetList && targetList !== currentList && currentList.id && currentList.id.endsWith('-list')) {
                    // Move card to correct column with smooth animation
                    swappedCard.style.transition = 'all 0.3s ease';
                    swappedCard.style.opacity = '0.5';
                    
                    setTimeout(() => {
                        swappedCard.remove();
                        targetList.appendChild(swappedCard);
                        swappedCard.style.opacity = '1';
                        updateColumnBadges();
                    }, 150);
                } else {
                    updateColumnBadges();
                }
            }
        } else {
            // If not a card swap, might be a column update
            updateColumnBadges();
        }
    });

    // ========== DRAG & DROP ==========
    function initializeDragAndDrop() {
        ['todo', 'doing', 'done'].forEach(status => {
            const listElement = document.getElementById(`${status}-list`);
            if (!listElement) return;

            new Sortable(listElement, {
                group: 'kanban',
                animation: 200,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                forceFallback: true,
                fallbackClass: 'sortable-drag',
                onEnd: function(evt) {
                    const projectCard = evt.item;
                    const projectId = projectCard.dataset.projectId;
                    const newStatus = evt.to.dataset.status;
                    const oldStatus = evt.from.dataset.status;

                    // Only update if actually moved to different column
                    if (newStatus !== oldStatus && projectId) {
                        updateProjectStatus(projectId, newStatus);
                    }
                }
            });
        });
    }

    function updateProjectStatus(projectId, newStatus) {
        // Send AJAX request to update status
        fetch(`/projects/${projectId}/status/ajax`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-User-Name': getUserName(),
                'X-User-Color': getUserColor()
            },
            body: `status=${newStatus}`
        })
        .then(response => {
            if (response.ok) {
                updateColumnBadges();
                // Success handled via WebSocket broadcast
            } else {
                showToast('Failed to update project status', 'error');
                // Reload to fix state
                reloadAllColumns();
            }
        })
        .catch(error => {
            console.error('Error updating status:', error);
            showToast('Error updating project status', 'error');
            reloadAllColumns();
        });
    }

    // ========== INITIALIZE ==========
    connect();
    
    // Update timers immediately on page load
    updateTimers();
    
    // Update timers every second for live display
    setInterval(updateTimers, 1000);
    
    // Also update after a short delay to ensure data attributes are loaded
    setTimeout(updateTimers, 100);

    // Initialize drag & drop
    document.addEventListener('DOMContentLoaded', function() {
        initializeDragAndDrop();
    });

    // Reinitialize drag & drop after HTMX swaps
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Only reinitialize if a column list was swapped
        if (event.detail.target && event.detail.target.id && event.detail.target.id.endsWith('-list')) {
            setTimeout(initializeDragAndDrop, 100);
        }
    });

    // Cleanup on disconnect
    window.addEventListener('beforeunload', function() {
        sendPresence(false);
        if (stompClient) {
            stompClient.disconnect();
        }
    });

    // Expose functions globally for HTMX fragments
    window.getUserName = getUserName;
    window.getUserColor = getUserColor;
</script>

</body>
</html>
